---
title: "OPTIMA Cost-Effectiveness Analysis - Primary Deterministic Results"
author: "Benjamin Enns"
date: Sys.Date()
output: html_document
---

```{r,echo=T,eval=T,include=F}
library(dplyr)    # to manipulate data
library(ggplot2)  # for nice looking plots
library(Hmisc)
library(psych)
library(stats)
library(summarytools)
library(table1)
library(tidyverse)
library(plyr)
library(readr)
```

`# Load functions`
```{r, echo=F, eval=T, warning=FALSE, cache=F, message=F}
source("R/input_parameter_functions.R") # load input parameter files
source("R/model_setup_functions.R") # load model functions
source("R/ICER_functions.R") # load functions to calculate outputs
source("R/plot_functions.R") # functions to create plots
```

`# Load parameter sets for BNX and Methadone scenarios`
```{r, echo=F, eval=T, warning=FALSE, cache=F, message=F}
# BNX scenario
l_params_BUP <- load_all_params(file.init = "data/init_params.csv",
                                file.init_dist = "data/init_dist_bup.csv",
                                file.mort = "data/all_cause_mortality.csv",
                                file.death_hr = "data/death_hr.csv",
                                file.frailty = "data/frailty.csv",
                                file.weibull = "data/weibull.csv",
                                file.unconditional = "data/unconditional.csv",
                                file.overdose = "data/overdose.csv",
                                file.fentanyl = "data/fentanyl.csv",
                                file.hiv = "data/hiv_sero.csv",
                                file.hcv = "data/hcv_sero.csv",
                                file.costs = "data/costs.csv",
                                file.crime_costs = "data/crime_costs.csv",
                                file.qalys = "data/qalys.csv")

# Methadone scenario
l_params_MET <- load_all_params(file.init = "data/init_params.csv",
                                file.init_dist = "data/init_dist_met.csv",
                                file.mort = "data/all_cause_mortality.csv",
                                file.death_hr = "data/death_hr.csv",
                                file.frailty = "data/frailty.csv",
                                file.weibull = "data/weibull.csv",
                                file.unconditional = "data/unconditional.csv",
                                file.overdose = "data/overdose.csv",
                                file.fentanyl = "data/fentanyl.csv",
                                file.hiv = "data/hiv_sero.csv",
                                file.hcv = "data/hcv_sero.csv",
                                file.costs = "data/costs.csv",
                                file.crime_costs = "data/crime_costs.csv",
                                file.qalys = "data/qalys.csv")
```

`# Run deterministic scenarios for BNX and methadone`
```{r, echo=F, eval=T, warning=FALSE, cache=F, message=F}
source("R/input_parameter_functions.R")
source("R/model_setup_functions.R")
source("R/ICER_functions.R")
```

`# Create trace plots`
```{r, echo=F, eval=T, warning=FALSE, cache=F, message=F}
#### Create plots ####
l_trace_base <- trace_plots(outcomes = l_out_markov_base)
l_trace_BUP  <- trace_plots(outcomes = l_out_markov_BUP)
l_trace_MET  <- trace_plots(outcomes = l_out_markov_MET)
```

# Model Trace Plots

**1. Early Take-Home BNX** 
```{r, echo=F, eval=T}
# BUP
pdf(file = "Plots/Markov Trace/Modified Model Spec/full_trace_BUP.pdf", width = 8, height = 9)
multiplot(plotlist = l_trace_BUP[[4]], layout = l_trace_BUP[[5]])
dev.off()
```

**1. Methadone Standard of Care** 
```{r, echo=F, eval=T}
# MET
pdf(file = "Plots/Markov Trace/Modified Model Spec/full_trace_MET.pdf", width = 8, height = 9)
multiplot(plotlist = l_trace_MET[[4]], layout = l_trace_MET[[5]])
dev.off()
```

<p>&nbsp;</p>
**1.2 OAT treatment initiation characteristics**
```{r, echo=F, eval=T}
bl_oat_init <- tbl_df_baseline %>%
  select(entity_id, oat_medication, oat_bnx, oat_rx_dose, oat_ing_dose, oat_dose_adj) #%>% filter(oat_medication == "MET")
#bl_bnx_init <- tbl_df_baseline %>%
#  select(entity_id, oat_medication, oat_bnx, oat_rx_dose, oat_ing_dose, oat_dose_adj) %>% filter(oat_medication == "BNX")

label(bl_oat_init$oat_rx_dose) <- "Initial prescribed dose"
label(bl_oat_init$oat_ing_dose) <- "Initial ingested dose"
label(bl_oat_init$oat_dose_adj) <- "Dose adjusted"

table1(~oat_rx_dose + oat_ing_dose + oat_dose_adj | oat_medication, data = bl_oat_init)
```

```{r, echo=F, eval=F}
p <- ggplot(bl_met_init, aes(x = oat_ing_dose)) +
  geom_histogram(fill="#999999", position="dodge")+
  #geom_vline(data = met_mean, aes(xintercept = grp.mean),
  #           linetype="dashed")+
  theme(legend.position="top")
p
# Use custom color palettes
p + scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))

```

<p>&nbsp;</p>
**2. Descriptive statistics for full trial observations (time-varying)**
<p>&nbsp;</p>
**2.1 Base health state observations and stratifications by trial arm (MET and BNX states allowing for concurrent opioid use)**
```{r, echo=F, eval=T}
tv_health_states <- tbl_df_hs_episode %>% 
  select(trial_arm, health_state, co_stim, co_opioid, fent, co_tx) %>%
  mutate(co_stim = ifelse(co_stim == 1, "Yes", "No"),
         co_opioid = ifelse(co_opioid == 1, "Yes", "No"),
         fent = ifelse(fent == 1, "Yes", "No"),
         co_tx = ifelse(co_tx == 1, "Yes", "No"))
         #health_state = ifelse(health_state == "ABS", "ABS (obs)",
          #              ifelse(health_state == "BNX", "BNX (obs)",
           #             ifelse(health_state == "MET", "MET (obs)",
            #            ifelse(health_state == "REL", "REL (obs)", NA)))))

label(tv_health_states$trial_arm) <- "Trial arm"
label(tv_health_states$health_state) <- "Health state"
label(tv_health_states$co_stim) <- "Concurrent stimulant"
label(tv_health_states$co_opioid) <- "Concurrent opioid"
label(tv_health_states$fent) <- "Fentanyl"
label(tv_health_states$co_tx) <- "Concurrent treatment (MET + BNX)"

table1(~health_state + co_stim + co_opioid + fent + co_tx | trial_arm, data = tv_health_states)
```
