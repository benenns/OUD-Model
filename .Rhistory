# From HIV
a_TDP_1[HIV & INJ, ODN & INJ & HIV, ]  <- a_TDP_1[HIV & INJ, ODN & INJ & HIV, ] * (1 - p_HIV_HCV_ODN_INJ)
a_TDP_2[HIV & INJ, ODN & INJ & HIV, ]  <- a_TDP_2[HIV & INJ, ODN & INJ & HIV, ] * (1 - p_HIV_HCV_ODN_INJ)
a_TDP_3[HIV & INJ, ODN & INJ & HIV, ]  <- a_TDP_3[HIV & INJ, ODN & INJ & HIV, ] * (1 - p_HIV_HCV_ODN_INJ)
a_TDP_1[HIV & INJ, ODN & INJ & COI, ]  <- a_TDP_1[HIV & INJ, ODN & INJ & COI, ] * p_HIV_HCV_ODN_INJ # Probability of HCV conditional on HIV
a_TDP_2[HIV & INJ, ODN & INJ & COI, ]  <- a_TDP_2[HIV & INJ, ODN & INJ & COI, ] * p_HIV_HCV_ODN_INJ
a_TDP_3[HIV & INJ, ODN & INJ & COI, ]  <- a_TDP_3[HIV & INJ, ODN & INJ & COI, ] * p_HIV_HCV_ODN_INJ
# From HCV
a_TDP_1[HCV & INJ, ODN & INJ & HCV, ]  <- a_TDP_1[HCV & INJ, ODN & INJ & HCV, ] * (1 - p_HCV_HIV_ODN_INJ)
a_TDP_2[HCV & INJ, ODN & INJ & HCV, ]  <- a_TDP_2[HCV & INJ, ODN & INJ & HCV, ] * (1 - p_HCV_HIV_ODN_INJ)
a_TDP_3[HCV & INJ, ODN & INJ & HCV, ]  <- a_TDP_3[HCV & INJ, ODN & INJ & HCV, ] * (1 - p_HCV_HIV_ODN_INJ)
a_TDP_1[HCV & INJ, ODN & INJ & COI, ]  <- a_TDP_1[HCV & INJ, ODN & INJ & COI, ] * p_HCV_HIV_ODN_INJ # Probability of HIV conditional on HCV
a_TDP_2[HCV & INJ, ODN & INJ & COI, ]  <- a_TDP_2[HCV & INJ, ODN & INJ & COI, ] * p_HCV_HIV_ODN_INJ
a_TDP_3[HCV & INJ, ODN & INJ & COI, ]  <- a_TDP_3[HCV & INJ, ODN & INJ & COI, ] * p_HCV_HIV_ODN_INJ
# ODF
# From NEG
a_TDP_1[NEG & INJ, ODF & INJ & NEG, ]  <- a_TDP_1[NEG & INJ, ODF & INJ & NEG, ] * 1
a_TDP_2[NEG & INJ, ODF & INJ & NEG, ]  <- a_TDP_2[NEG & INJ, ODF & INJ & NEG, ] * 1
a_TDP_3[NEG & INJ, ODF & INJ & NEG, ]  <- a_TDP_3[NEG & INJ, ODF & INJ & NEG, ] * 1
a_TDP_1[NEG & INJ, ODF & INJ & HIV, ]  <- a_TDP_1[NEG & INJ, ODF & INJ & HIV, ] * 0
a_TDP_2[NEG & INJ, ODF & INJ & HIV, ]  <- a_TDP_2[NEG & INJ, ODF & INJ & HIV, ] * 0
a_TDP_3[NEG & INJ, ODF & INJ & HIV, ]  <- a_TDP_3[NEG & INJ, ODF & INJ & HIV, ] * 0
a_TDP_1[NEG & INJ, ODF & INJ & HCV, ]  <- a_TDP_1[NEG & INJ, ODF & INJ & HCV, ] * 0
a_TDP_2[NEG & INJ, ODF & INJ & HCV, ]  <- a_TDP_2[NEG & INJ, ODF & INJ & HCV, ] * 0
a_TDP_3[NEG & INJ, ODF & INJ & HCV, ]  <- a_TDP_3[NEG & INJ, ODF & INJ & HCV, ] * 0
# From HIV
a_TDP_1[HIV & INJ, ODF & INJ & HIV, ]  <- a_TDP_1[HIV & INJ, ODF & INJ & HIV, ] * 1
a_TDP_2[HIV & INJ, ODF & INJ & HIV, ]  <- a_TDP_2[HIV & INJ, ODF & INJ & HIV, ] * 1
a_TDP_3[HIV & INJ, ODF & INJ & HIV, ]  <- a_TDP_3[HIV & INJ, ODF & INJ & HIV, ] * 1
a_TDP_1[HIV & INJ, ODF & INJ & COI, ]  <- a_TDP_1[HIV & INJ, ODF & INJ & COI, ] * 0
a_TDP_2[HIV & INJ, ODF & INJ & COI, ]  <- a_TDP_2[HIV & INJ, ODF & INJ & COI, ] * 0
a_TDP_3[HIV & INJ, ODF & INJ & COI, ]  <- a_TDP_3[HIV & INJ, ODF & INJ & COI, ] * 0
# From HCV
a_TDP_1[HCV & INJ, ODF & INJ & HCV, ]  <- a_TDP_1[HCV & INJ, ODF & INJ & HCV, ] * 1
a_TDP_2[HCV & INJ, ODF & INJ & HCV, ]  <- a_TDP_2[HCV & INJ, ODF & INJ & HCV, ] * 1
a_TDP_3[HCV & INJ, ODF & INJ & HCV, ]  <- a_TDP_3[HCV & INJ, ODF & INJ & HCV, ] * 1
a_TDP_1[HCV & INJ, ODF & INJ & COI, ]  <- a_TDP_1[HCV & INJ, ODF & INJ & COI, ] * 0
a_TDP_2[HCV & INJ, ODF & INJ & COI, ]  <- a_TDP_2[HCV & INJ, ODF & INJ & COI, ] * 0
a_TDP_3[HCV & INJ, ODF & INJ & COI, ]  <- a_TDP_3[HCV & INJ, ODF & INJ & COI, ] * 0
# ABS
# From NEG
a_TDP_1[NEG & INJ, ABS & INJ & NEG, ]  <- a_TDP_1[NEG & INJ, ABS & INJ & NEG, ] * (1 - p_HIV_ABS_INJ - p_HCV_ABS_INJ)
a_TDP_2[NEG & INJ, ABS & INJ & NEG, ]  <- a_TDP_2[NEG & INJ, ABS & INJ & NEG, ] * (1 - p_HIV_ABS_INJ - p_HCV_ABS_INJ)
a_TDP_3[NEG & INJ, ABS & INJ & NEG, ]  <- a_TDP_3[NEG & INJ, ABS & INJ & NEG, ] * (1 - p_HIV_ABS_INJ - p_HCV_ABS_INJ)
a_TDP_1[NEG & INJ, ABS & INJ & HIV, ]  <- a_TDP_1[NEG & INJ, ABS & INJ & HIV, ] * p_HIV_ABS_INJ
a_TDP_2[NEG & INJ, ABS & INJ & HIV, ]  <- a_TDP_2[NEG & INJ, ABS & INJ & HIV, ] * p_HIV_ABS_INJ
a_TDP_3[NEG & INJ, ABS & INJ & HIV, ]  <- a_TDP_3[NEG & INJ, ABS & INJ & HIV, ] * p_HIV_ABS_INJ
a_TDP_1[NEG & INJ, ABS & INJ & HCV, ]  <- a_TDP_1[NEG & INJ, ABS & INJ & HCV, ] * p_HCV_ABS_INJ
a_TDP_2[NEG & INJ, ABS & INJ & HCV, ]  <- a_TDP_2[NEG & INJ, ABS & INJ & HCV, ] * p_HCV_ABS_INJ
a_TDP_3[NEG & INJ, ABS & INJ & HCV, ]  <- a_TDP_3[NEG & INJ, ABS & INJ & HCV, ] * p_HCV_ABS_INJ
# From HIV
a_TDP_1[HIV & INJ, ABS & INJ & HIV, ]  <- a_TDP_1[HIV & INJ, ABS & INJ & HIV, ] * (1 - p_HIV_HCV_ABS_INJ)
a_TDP_2[HIV & INJ, ABS & INJ & HIV, ]  <- a_TDP_2[HIV & INJ, ABS & INJ & HIV, ] * (1 - p_HIV_HCV_ABS_INJ)
a_TDP_3[HIV & INJ, ABS & INJ & HIV, ]  <- a_TDP_3[HIV & INJ, ABS & INJ & HIV, ] * (1 - p_HIV_HCV_ABS_INJ)
a_TDP_1[HIV & INJ, ABS & INJ & COI, ]  <- a_TDP_1[HIV & INJ, ABS & INJ & COI, ] * p_HIV_HCV_ABS_INJ # Probability of HCV conditional on HIV
a_TDP_2[HIV & INJ, ABS & INJ & COI, ]  <- a_TDP_2[HIV & INJ, ABS & INJ & COI, ] * p_HIV_HCV_ABS_INJ
a_TDP_3[HIV & INJ, ABS & INJ & COI, ]  <- a_TDP_3[HIV & INJ, ABS & INJ & COI, ] * p_HIV_HCV_ABS_INJ
# From HCV
a_TDP_1[HCV & INJ, ABS & INJ & HCV, ]  <- a_TDP_1[HCV & INJ, ABS & INJ & HCV, ] * (1 - p_HCV_HIV_ABS_INJ)
a_TDP_2[HCV & INJ, ABS & INJ & HCV, ]  <- a_TDP_2[HCV & INJ, ABS & INJ & HCV, ] * (1 - p_HCV_HIV_ABS_INJ)
a_TDP_3[HCV & INJ, ABS & INJ & HCV, ]  <- a_TDP_3[HCV & INJ, ABS & INJ & HCV, ] * (1 - p_HCV_HIV_ABS_INJ)
a_TDP_1[HCV & INJ, ABS & INJ & COI, ]  <- a_TDP_1[HCV & INJ, ABS & INJ & COI, ] * p_HCV_HIV_ABS_INJ # Probability of HIV conditional on HCV
a_TDP_2[HCV & INJ, ABS & INJ & COI, ]  <- a_TDP_2[HCV & INJ, ABS & INJ & COI, ] * p_HCV_HIV_ABS_INJ
a_TDP_3[HCV & INJ, ABS & INJ & COI, ]  <- a_TDP_3[HCV & INJ, ABS & INJ & COI, ] * p_HCV_HIV_ABS_INJ
#### Disallowed transitions (ensure that impossible transitions are set to zero) ####
# Episode rules
a_TDP_1[EP1, EP3, ] <- a_TDP_2[EP1, EP3, ] <- a_TDP_3[EP1, EP3, ] <- 0
a_TDP_1[EP2, EP1, ] <- a_TDP_2[EP2, EP1, ] <- a_TDP_3[EP2, EP1, ] <- 0
a_TDP_1[EP3, EP1, ] <- a_TDP_2[EP3, EP1, ] <- a_TDP_3[EP3, EP1, ] <- 0
a_TDP_1[EP3, EP2, ] <- a_TDP_2[EP3, EP2, ] <- a_TDP_3[EP3, EP2, ] <- 0
# Seroconversions
a_TDP_1[HIV, NEG, ] <- a_TDP_2[HIV, NEG, ] <- a_TDP_3[HIV, NEG, ] <- 0
a_TDP_1[HCV, NEG, ] <- a_TDP_2[HCV, NEG, ] <- a_TDP_3[HCV, NEG, ] <- 0
a_TDP_1[COI, NEG, ] <- a_TDP_2[COI, NEG, ] <- a_TDP_3[COI, NEG, ] <- 0
a_TDP_1[HIV, HCV, ] <- a_TDP_2[HIV, HCV, ] <- a_TDP_3[HIV, HCV, ] <- 0
a_TDP_1[HCV, HIV, ] <- a_TDP_2[HCV, HIV, ] <- a_TDP_3[HCV, HIV, ] <- 0
a_TDP_1[COI, HIV, ] <- a_TDP_2[COI, HIV, ] <- a_TDP_3[COI, HIV, ] <- 0
a_TDP_1[COI, HCV, ] <- a_TDP_2[COI, HCV, ] <- a_TDP_3[COI, HCV, ] <- 0
a_TDP_1[COI, NEG, ] <- a_TDP_2[COI, NEG, ] <- a_TDP_3[COI, NEG, ] <- 0
a_TDP_1[NEG, COI, ] <- a_TDP_2[NEG, COI, ] <- a_TDP_3[NEG, COI, ] <- 0
# Conditional transitions
# Next episode with out-of-treatment(OOT) EPi -> treatment(TX) EP(i+1)
a_TDP_1[all_TX & EP1, all_TX & EP2, ] <- a_TDP_2[all_TX & EP1, all_TX & EP2, ] <- a_TDP_3[all_TX & EP1, all_TX & EP2, ] <- 0
a_TDP_1[all_TX & EP1, all_TX & EP3, ] <- a_TDP_2[all_TX & EP1, all_TX & EP3, ] <- a_TDP_3[all_TX & EP1, all_TX & EP3, ] <- 0
a_TDP_1[all_TX & EP2, all_TX & EP3, ] <- a_TDP_2[all_TX & EP2, all_TX & EP3, ] <- a_TDP_3[all_TX & EP2, all_TX & EP3, ] <- 0
a_TDP_1[OOT & EP1, OOT & EP2, ] <- a_TDP_2[OOT & EP1, OOT & EP2, ] <- a_TDP_3[OOT & EP1, OOT & EP2, ] <- 0
a_TDP_1[OOT & EP1, OOT & EP3, ] <- a_TDP_2[OOT & EP1, OOT & EP3, ] <- a_TDP_3[OOT & EP1, OOT & EP3, ] <- 0
a_TDP_1[OOT & EP2, OOT & EP3, ] <- a_TDP_2[OOT & EP2, OOT & EP3, ] <- a_TDP_3[OOT & EP2, OOT & EP3, ] <- 0
a_TDP_1[all_TX & EP1, OOT & EP2, ] <- a_TDP_2[all_TX & EP1, OOT & EP2, ] <- a_TDP_3[all_TX & EP1, OOT & EP2, ] <- 0
a_TDP_1[all_TX & EP2, OOT & EP3, ] <- a_TDP_2[all_TX & EP2, OOT & EP3, ] <- a_TDP_3[all_TX & EP2, OOT & EP3, ] <- 0
a_TDP_1[OOT & EP1, all_TX & EP1, ] <- a_TDP_2[OOT & EP1, all_TX & EP1, ] <- a_TDP_3[OOT & EP1, all_TX & EP1, ] <- 0
a_TDP_1[OOT & EP2, all_TX & EP2, ] <- a_TDP_2[OOT & EP2, all_TX & EP2, ] <- a_TDP_3[OOT & EP2, all_TX & EP2, ] <- 0
# Time dependent state-exit probabilities (from weibull estimates)
write.csv(m_TDP_1,"checks/state-time dependent transitions/m_TDP_1.csv", row.names = TRUE)
write.csv(m_TDP_2,"checks/state-time dependent transitions/m_TDP_2.csv", row.names = TRUE)
write.csv(m_TDP_3,"checks/state-time dependent transitions/m_TDP_3.csv", row.names = TRUE)
write.csv(m_leave_1,"checks/state-time dependent transitions/m_leave_1.csv", row.names = TRUE)
write.csv(m_leave_2,"checks/state-time dependent transitions/m_leave_2.csv", row.names = TRUE)
write.csv(m_leave_3,"checks/state-time dependent transitions/m_leave_3.csv", row.names = TRUE)
# Mortality matrix
#write.csv(m_mort,"checks/mortality/m_mort.csv", row.names = TRUE)
# Overdose
write.csv(m_ODN_first,"checks/overdose/m_ODN_first.csv", row.names = TRUE)
write.csv(m_ODF_first,"checks/overdose/m_ODF_first.csv", row.names = TRUE)
write.csv(m_ODN,"checks/overdose/m_ODN.csv", row.names = TRUE)
write.csv(m_ODF,"checks/overdose/m_ODF.csv", row.names = TRUE)
# Unconditional state transitions
# First month (state-time)
write.csv(a_UP_first[, , 1], "checks/state transitions/a_UP_first_2018.csv")
write.csv(a_UP_first[, , 2], "checks/state transitions/a_UP_first_2019.csv")
write.csv(a_UP_first[, , 3], "checks/state transitions/a_UP_first_2020.csv")
#write.csv(m_UP,"checks/state transitions/m_UP.csv", row.names = TRUE)
# Month 2+ (state-time)
write.csv(a_UP[, , 1], "checks/state transitions/a_UP_2018.csv")
write.csv(a_UP[, , 2], "checks/state transitions/a_UP_2019.csv")
write.csv(a_UP[, , 3], "checks/state transitions/a_UP_2020.csv")
#write.csv(m_UP_4wk,"checks/state transitions/m_UP_4wk.csv", row.names = TRUE)
# First period full array
#write.csv(initial,"checks/initial_full.csv", row.names = TRUE)
# Array at time = 50 months
#write.csv(array_1,"checks/array_1.csv", row.names = TRUE)
# Array at time = max
#write.csv(array_2,"checks/array_2.csv", row.names = TRUE)
# Full array at 24 months
array_2018_24m <- a_TDP_1[, , 24]
array_2019_24m <- a_TDP_2[, , 24]
array_2020_24m <- a_TDP_3[, , 24]
write.csv(array_2018_24m,"checks/full array/array_2018_24m.csv", row.names = TRUE)
write.csv(array_2019_24m,"checks/full array/array_2019_24m.csv", row.names = TRUE)
write.csv(array_2020_24m,"checks/full array/array_2020_24m.csv", row.names = TRUE)
# Full array at time = max
array_2018_last <- a_TDP_1[, , n_t]
array_2019_last <- a_TDP_2[, , n_t]
array_2020_last <- a_TDP_3[, , n_t]
write.csv(array_2018_last,"checks/full array/array_2018_last.csv", row.names = TRUE)
write.csv(array_2019_last,"checks/full array/array_2019_last.csv", row.names = TRUE)
write.csv(array_2020_last,"checks/full array/array_2020_last.csv", row.names = TRUE)
# Initial state occupancy at model initiation
write.csv(v_s_init,"checks/initial/v_s_init.csv", row.names = TRUE)
# Mortality matrix
write.csv(m_mort,"checks/mortality/m_mort.csv", row.names = TRUE)
# Full array at time = 1
array_2018_1m <- a_TDP_1[, , 1]
array_2019_1m <- a_TDP_2[, , 1]
array_2020_1m <- a_TDP_3[, , 1]
write.csv(array_2018_1m,"checks/full array/array_2018_1m.csv", row.names = TRUE)
write.csv(array_2019_1m,"checks/full array/array_2019_1m.csv", row.names = TRUE)
write.csv(array_2020_1m,"checks/full array/array_2020_1m.csv", row.names = TRUE)
# Create Markov Trace
# Initialize population
a_M_trace <- array(0, dim = c((n_t + 1), n_states, (n_t + 1)),
dimnames = list(0:n_t, v_n_states, 0:n_t))
a_M_trace[1, , 1] <- v_s_init
# All model time periods
# Split into three periods 0-12; 12-24; 24+ to account for overall time-varying overdose parameters
# Months 0-12 (model-time)
for(i in 2:11){
# Time spent in given health state
# First month (state-time)
for(j in 1:(i - 1)){
# state-time-dependent transition probability (j) * age (model-time)-specific mortality (i) * model-time-specific overdose (track in separate matrix)
m_sojourn <- a_TDP_1[, , j] * m_alive[, i - 1] # state-time transition matrix at state-time j, re-weighted for model-time (age) varying mortality at each time point
v_current_state <- as.vector(a_M_trace[i - 1, , j]) # all in current state
v_same_state <- as.vector(v_current_state * diag(m_sojourn)) # individuals remaining in state next period
a_M_trace[i, ,j + 1] <- v_same_state # add remain to next period
diag(m_sojourn) <- 0 # reset remain to 0 once counted
v_new_state <- as.vector(v_current_state %*% m_sojourn) # populate new states post-transition (excluding remaining)
a_M_trace[i, ,1] <- v_new_state + a_M_trace[i, ,1] # add new state %'s to array
}
}
# Months 12-23 (model-time)
for(i in 12:23){
# Time spent in given health state
# First month (state-time)
for(j in 1:(i - 1)){
# state-time-dependent transition probability (j) * age (model-time)-specific mortality (i) * model-time-specific overdose (track in separate matrix)
m_sojourn <- a_TDP_2[, , j] * m_alive[, i - 1] # state-time transition matrix at state-time j, re-weighted for model-time (age) varying mortality at each time point
v_current_state <- as.vector(a_M_trace[i - 1, , j]) # all in current state
v_same_state <- as.vector(v_current_state * diag(m_sojourn)) # individuals remaining in state next period
a_M_trace[i, ,j + 1] <- v_same_state # add remain to next period
diag(m_sojourn) <- 0 # reset remain to 0 once counted
v_new_state <- as.vector(v_current_state %*% m_sojourn) # populate new states post-transition (excluding remaining)
a_M_trace[i, ,1] <- v_new_state + a_M_trace[i, ,1] # add new state %'s to array
}
}
# Months 24+ (model-time)
for(i in 24:(n_t)){
# Time spent in given health state
# First month (state-time)
for(j in 1:(i - 1)){
m_sojourn <- a_TDP_3[, , j] * m_alive[, i - 1] # state-time transition matrix at state-time j, re-weighted for model-time (age) varying mortality at each time point, time-varying overdose (t=3)
v_current_state <- as.vector(a_M_trace[i - 1, , j]) # all in current state
v_same_state <- as.vector(v_current_state * diag(m_sojourn)) # individuals remaining in state next period
a_M_trace[i, ,j + 1] <- v_same_state # add remain to next period
diag(m_sojourn) <- 0 # reset remain to 0 once counted
v_new_state <- as.vector(v_current_state %*% m_sojourn) # populate new states post-transition (excluding remaining)
a_M_trace[i, ,1] <- v_new_state + a_M_trace[i, ,1] # add new state %'s to array
}
}
# Collect trace for time-periods across all model states
m_M_trace <- array(0, dim = c((n_t + 1), n_states),
dimnames = list(0:n_t, v_n_states))
for (i in 1:n_t){
m_M_trace[i, ] <- rowSums(a_M_trace[i, ,])
}
#### Check transition array ####
check_transition_probability(a_P = a_TDP_1, err_stop = err_stop, verbose = verbose) # check all probs [0, 1]
#### Check transition array ####
check_transition_probability(a_P = a_TDP_1, err_stop = err_stop, verbose = verbose) # check all probs [0, 1]
check_transition_probability(a_P = a_TDP_2, err_stop = err_stop, verbose = verbose) # check all probs [0, 1]
check_transition_probability(a_P = a_TDP_3, err_stop = err_stop, verbose = verbose) # check all probs [0, 1]
check_sum_of_transition_array(a_P = a_TDP_1, n_states = n_states, n_t = n_t, err_stop = err_stop, verbose = verbose) # check prob sums = 1
check_sum_of_transition_array(a_P = a_TDP_2, n_states = n_states, n_t = n_t, err_stop = err_stop, verbose = verbose) # check prob sums = 1
check_sum_of_transition_array(a_P = a_TDP_3, n_states = n_states, n_t = n_t, err_stop = err_stop, verbose = verbose) # check prob sums = 1
rm(list = ls()) # to clean the workspace
library(dplyr)    # to manipulate data
library(reshape2) # to transform data
library(ggplot2)  # for nice looking plots
library(scales)   # for dollar signs and commas
library(dampack)  # for CEA and calculate ICERs
library(tidyverse)
library(rbenchmark)
library(microbenchmark)
# Call model setup functions
source("R/input_parameter_functions.R")
source("R/model_setup_functions.R")
source("R/calibration_functions.R")
source("R/ICER_functions.R")
# Load parameters
l_params_all <- load_all_params(file.init = "data/init_params.csv",
file.init_dist = "data/init_dist.csv",
file.mort = "data/all_cause_mortality.csv",
file.death_hr = "data/death_hr.csv",
file.frailty = "data/frailty.csv",
file.weibull_scale = "data/weibull_scale.csv",
file.weibull_shape = "data/weibull_shape.csv",
file.unconditional = "data/unconditional.csv",
file.overdose = "data/overdose.csv",
file.hiv = "data/hiv_sero.csv",
file.hcv = "data/hcv_sero.csv",
file.costs = "data/costs.csv",
file.crime_costs = "data/crime_costs.csv",
file.qalys = "data/qalys.csv")
rm(list = ls()) # to clean the workspace
library(dplyr)    # to manipulate data
library(reshape2) # to transform data
library(ggplot2)  # for nice looking plots
library(scales)   # for dollar signs and commas
library(dampack)  # for CEA and calculate ICERs
library(tidyverse)
library(rbenchmark)
library(microbenchmark)
# Call model setup functions
source("R/input_parameter_functions.R")
source("R/model_setup_functions.R")
source("R/calibration_functions.R")
source("R/ICER_functions.R")
# Load parameters
l_params_all <- load_all_params(file.init = "data/init_params.csv",
file.init_dist = "data/init_dist.csv",
file.mort = "data/all_cause_mortality.csv",
file.death_hr = "data/death_hr.csv",
file.frailty = "data/frailty.csv",
file.weibull_scale = "data/weibull_scale.csv",
file.weibull_shape = "data/weibull_shape.csv",
file.unconditional = "data/unconditional.csv",
file.overdose = "data/overdose.csv",
file.fentanyl = "data/fentanyl.csv",
file.hiv = "data/hiv_sero.csv",
file.hcv = "data/hcv_sero.csv",
file.costs = "data/costs.csv",
file.crime_costs = "data/crime_costs.csv",
file.qalys = "data/qalys.csv")
# Calibrated parameter values
load(file = "outputs/imis_output.RData")
# Benchmark model calibration
l_cali_targets <- list(ODF = read.csv(file = "data/cali_target_odf.csv", header = TRUE),
ODN = read.csv(file = "data/cali_target_odn.csv", header = TRUE))
n_cali_max_per <- max(c(l_cali_targets$ODF$Time, l_cali_targets$ODN$Time))
df_model_benchmark_cali <- microbenchmark("Markov Model (Cali)" = markov_model(l_params_all = l_params_all, cali = TRUE), times = 100)
plot_cali <- autoplot(df_model_benchmark_cali)
ggsave(plot_cali,
filename = "Plots/Benchmark/model_benchmark_cali.png",
width = 10, height = 7)
# Call model setup functions
source("R/input_parameter_functions.R")
source("R/model_setup_functions.R")
source("R/calibration_functions.R")
source("R/ICER_functions.R")
# Call model setup functions
source("R/input_parameter_functions.R")
source("R/model_setup_functions.R")
source("R/calibration_functions.R")
source("R/ICER_functions.R")
# Load parameters
l_params_all <- load_all_params(file.init = "data/init_params.csv",
file.init_dist = "data/init_dist.csv",
file.mort = "data/all_cause_mortality.csv",
file.death_hr = "data/death_hr.csv",
file.frailty = "data/frailty.csv",
file.weibull_scale = "data/weibull_scale.csv",
file.weibull_shape = "data/weibull_shape.csv",
file.unconditional = "data/unconditional.csv",
file.overdose = "data/overdose.csv",
file.fentanyl = "data/fentanyl.csv",
file.hiv = "data/hiv_sero.csv",
file.hcv = "data/hcv_sero.csv",
file.costs = "data/costs.csv",
file.crime_costs = "data/crime_costs.csv",
file.qalys = "data/qalys.csv")
# Calibrated parameter values
load(file = "outputs/imis_output.RData")
# Benchmark model calibration
l_cali_targets <- list(ODF = read.csv(file = "data/cali_target_odf.csv", header = TRUE),
ODN = read.csv(file = "data/cali_target_odn.csv", header = TRUE))
n_cali_max_per <- max(c(l_cali_targets$ODF$Time, l_cali_targets$ODN$Time))
df_model_benchmark_cali <- microbenchmark("Markov Model (Cali)" = markov_model(l_params_all = l_params_all, cali = TRUE), times = 100)
plot_cali <- autoplot(df_model_benchmark_cali)
ggsave(plot_cali,
filename = "Plots/Benchmark/model_benchmark_cali.png",
width = 10, height = 7)
rm(list = ls()) # to clean the workspace
#### Load packages, data and functions ####
#### Load packages and functions ####
library(dplyr)    # to manipulate data
library(reshape2) # to transform data
library(ggplot2)  # for nice looking plots
library(ggridges) # specialized ridge plots
library(tidyverse)
library(lhs)
library(IMIS)
# To-do: Move functions into R package for OUD model
source("R/input_parameter_functions.R")
source("R/model_setup_functions.R")
source("R/calibration_functions.R")
# Load model inputs #
l_params_all <- load_all_params(file.init = "data/init_params.csv",
file.init_dist = "data/init_dist.csv", # calibrate on full trial sample (x% bup; x% met)
file.mort = "data/all_cause_mortality.csv",
file.death_hr = "data/death_hr.csv",
file.frailty = "data/frailty.csv",
file.weibull_scale = "data/weibull_scale.csv",
file.weibull_shape = "data/weibull_shape.csv",
file.unconditional = "data/unconditional.csv",
file.overdose = "data/overdose.csv", # includes calibration-related parameters
file.fentanyl = "data/fentanyl.csv",
file.hiv = "data/hiv_sero.csv",
file.hcv = "data/hcv_sero.csv",
file.costs = "data/costs.csv",
file.crime_costs = "data/crime_costs.csv",
file.qalys = "data/qalys.csv")
v_params_calib <- c(n_BUP_OD = l_params_all$n_BUP_OD,
n_BUPC_OD = l_params_all$n_BUPC_OD,
n_MET_OD = l_params_all$n_MET_OD,
n_METC_OD = l_params_all$n_METC_OD,
n_REL_OD = l_params_all$n_REL_OD,
n_ABS_OD = l_params_all$n_ABS_OD,
n_TX_OD_mult = l_params_all$n_TX_OD_mult,
n_TXC_OD_mult = l_params_all$n_TXC_OD_mult,
n_REL_OD_mult = l_params_all$n_REL_OD_mult,
n_INJ_OD_mult = l_params_all$n_INJ_OD_mult,
n_fatal_OD = l_params_all$n_fatal_OD)
v_params <- c(n_TX_OD_scale   = l_params_all$n_TX_OD,
n_TXC_OD_scale  = l_params_all$n_TXC_OD,
n_REL_OD_scale   = l_params_all$n_REL_OD,
n_ABS_OD_high    = l_params_all$n_ABS_OD,
n_TX_OD_mult_scale  = l_params_all$n_TX_OD_mult,
n_TXC_OD_mult_scale = l_params_all$n_TXC_OD_mult,
n_REL_OD_mult_scale = l_params_all$n_REL_OD_mult,
n_INJ_OD_mult_scale = l_params_all$n_INJ_OD_mult,
n_fent_OD_mult_scale = l_params_all$n_fent_OD_mult,
n_fatal_OD_scale    = l_params_all$n_fatal_OD)
l_model_res <- calibration_out(v_params_calib = v_params,
l_params_all = l_params_all)
#### Load calibration targets ####
l_cali_targets <- list(ODF = read.csv(file = "data/cali_target_odf.csv", header = TRUE),
ODN = read.csv(file = "data/cali_target_odn.csv", header = TRUE))
# Max calibration periods
n_cali_max_per <- max(c(l_cali_targets$ODF$Time, l_cali_targets$ODN$Time))
l_model_res <- calibration_out(v_params_calib = v_params,
l_params_all = l_params_all)
l_out_markov <- markov_model(l_params_all = l_params_all, cali = TRUE)
l_out_markov$m_M_trace
l_params_all$n_fent_OD_mult_scale
l_params_all$n_fent_OD_scale
## CALIBRATION TEST ##
#### Load packages and functions ####
library(dplyr)    # to manipulate data
library(reshape2) # to transform data
library(ggplot2)  # for nice looking plots
library(ggridges) # specialized ridge plots
library(tidyverse)
library(lhs)
library(IMIS)
# To-do: Move functions into R package for OUD model
source("R/input_parameter_functions.R")
source("R/model_setup_functions.R")
source("R/calibration_functions.R")
# Load model inputs #
l_params_all <- load_all_params(file.init = "data/init_params.csv",
file.init_dist = "data/init_dist.csv", # calibrate on full trial sample (x% bup; x% met)
file.mort = "data/all_cause_mortality.csv",
file.death_hr = "data/death_hr.csv",
file.frailty = "data/frailty.csv",
file.weibull_scale = "data/weibull_scale.csv",
file.weibull_shape = "data/weibull_shape.csv",
file.unconditional = "data/unconditional.csv",
file.overdose = "data/overdose.csv", # includes calibration-related parameters
file.fentanyl = "data/fentanyl.csv",
file.hiv = "data/hiv_sero.csv",
file.hcv = "data/hcv_sero.csv",
file.costs = "data/costs.csv",
file.crime_costs = "data/crime_costs.csv",
file.qalys = "data/qalys.csv")
# Load calibration inputs #
v_cali_param_names <- c("'Overdose rate (treatment)'",
"'Overdose rate (treatment + opioid)'",
"'Overdose rate (active opioid)'",
"'Overdose rate (inactive opioid)'",
"'First month mult (treatment)'",
"'First month mult (treatment + opioid)'",
"'First month mult (active opioid)'",
"'Injection mult'",
"'Fentanyl mult'",
"'Fatal overdose rate'")
v_par1 <- c(n_TX_OD_shape   = l_params_all$n_TX_OD_shape,
n_TXC_OD_shape  = l_params_all$n_TXC_OD_shape,
n_REL_OD_shape   = l_params_all$n_REL_OD_shape,
n_ABS_OD_low    = l_params_all$n_ABS_OD_low,
n_TX_OD_mult_shape  = l_params_all$n_TX_OD_mult_shape,
n_TXC_OD_mult_shape = l_params_all$n_TXC_OD_mult_shape,
n_REL_OD_mult_shape = l_params_all$n_REL_OD_mult_shape,
n_INJ_OD_mult_shape = l_params_all$n_INJ_OD_mult_shape,
n_fent_OD_mult_shape = l_params_all$n_fent_OD_mult_shape,
n_fatal_OD_shape    = l_params_all$n_fatal_OD_shape) # lower bound estimate for each param
v_par2 <- c(n_TX_OD_scale   = l_params_all$n_TX_OD_scale,
n_TXC_OD_scale  = l_params_all$n_TXC_OD_scale,
n_REL_OD_scale   = l_params_all$n_REL_OD_scale,
n_ABS_OD_high    = l_params_all$n_ABS_OD_high,
n_TX_OD_mult_scale  = l_params_all$n_TX_OD_mult_scale,
n_TXC_OD_mult_scale = l_params_all$n_TXC_OD_mult_scale,
n_REL_OD_mult_scale = l_params_all$n_REL_OD_mult_scale,
n_INJ_OD_mult_scale = l_params_all$n_INJ_OD_mult_scale,
n_fent_OD_mult_scale = l_params_all$n_fent_OD_mult_scale,
n_fatal_OD_scale    = l_params_all$n_fatal_OD_scale)
## CALIBRATION TEST ##
#### Load packages and functions ####
library(dplyr)    # to manipulate data
library(reshape2) # to transform data
library(ggplot2)  # for nice looking plots
library(ggridges) # specialized ridge plots
library(tidyverse)
library(lhs)
library(IMIS)
# To-do: Move functions into R package for OUD model
source("R/input_parameter_functions.R")
source("R/model_setup_functions.R")
source("R/calibration_functions.R")
# Load model inputs #
l_params_all <- load_all_params(file.init = "data/init_params.csv",
file.init_dist = "data/init_dist.csv", # calibrate on full trial sample (x% bup; x% met)
file.mort = "data/all_cause_mortality.csv",
file.death_hr = "data/death_hr.csv",
file.frailty = "data/frailty.csv",
file.weibull_scale = "data/weibull_scale.csv",
file.weibull_shape = "data/weibull_shape.csv",
file.unconditional = "data/unconditional.csv",
file.overdose = "data/overdose.csv", # includes calibration-related parameters
file.fentanyl = "data/fentanyl.csv",
file.hiv = "data/hiv_sero.csv",
file.hcv = "data/hcv_sero.csv",
file.costs = "data/costs.csv",
file.crime_costs = "data/crime_costs.csv",
file.qalys = "data/qalys.csv")
# Load calibration inputs #
v_cali_param_names <- c("'Overdose rate (treatment)'",
"'Overdose rate (treatment + opioid)'",
"'Overdose rate (active opioid)'",
"'Overdose rate (inactive opioid)'",
"'First month mult (treatment)'",
"'First month mult (treatment + opioid)'",
"'First month mult (active opioid)'",
"'Injection mult'",
"'Fentanyl mult'",
"'Fatal overdose rate'")
v_par1 <- c(n_TX_OD_shape   = l_params_all$n_TX_OD_shape,
n_TXC_OD_shape  = l_params_all$n_TXC_OD_shape,
n_REL_OD_shape   = l_params_all$n_REL_OD_shape,
n_ABS_OD_low    = l_params_all$n_ABS_OD_low,
n_TX_OD_mult_shape  = l_params_all$n_TX_OD_mult_shape,
n_TXC_OD_mult_shape = l_params_all$n_TXC_OD_mult_shape,
n_REL_OD_mult_shape = l_params_all$n_REL_OD_mult_shape,
n_INJ_OD_mult_shape = l_params_all$n_INJ_OD_mult_shape,
n_fent_OD_mult_shape = l_params_all$n_fent_OD_mult_shape,
n_fatal_OD_shape    = l_params_all$n_fatal_OD_shape) # lower bound estimate for each param
v_par2 <- c(n_TX_OD_scale   = l_params_all$n_TX_OD_scale,
n_TXC_OD_scale  = l_params_all$n_TXC_OD_scale,
n_REL_OD_scale   = l_params_all$n_REL_OD_scale,
n_ABS_OD_high    = l_params_all$n_ABS_OD_high,
n_TX_OD_mult_scale  = l_params_all$n_TX_OD_mult_scale,
n_TXC_OD_mult_scale = l_params_all$n_TXC_OD_mult_scale,
n_REL_OD_mult_scale = l_params_all$n_REL_OD_mult_scale,
n_INJ_OD_mult_scale = l_params_all$n_INJ_OD_mult_scale,
n_fent_OD_mult_scale = l_params_all$n_fent_OD_mult_scale,
n_fatal_OD_scale    = l_params_all$n_fatal_OD_scale)
#### Load calibration targets ####
l_cali_targets <- list(ODF = read.csv(file = "data/cali_target_odf.csv", header = TRUE),
ODN = read.csv(file = "data/cali_target_odn.csv", header = TRUE))
# Max calibration periods
n_cali_max_per <- max(c(l_cali_targets$ODF$Time, l_cali_targets$ODN$Time))
test2 <- sample.prior(n_samp = 100)
View(test2)
